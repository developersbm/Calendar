generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Membership {
  id             Int       @id @default(autoincrement())
  type           String    // Free or Premium
  // maxFriends     Int    // Optionally remove if "friends" feature is no longer relevant
  // maxTemplates   Int
  // maxGroups      Int
  // maxSavingPlans Int
  users          User[]

  @@map("memberships")
}

model User {
  id               Int       @id @default(autoincrement())
  name             String
  email            String    @unique
  cognitoId        String    @unique
  membershipId     Int
  membership       Membership @relation(fields: [membershipId], references: [id])
  calendarId       Int?
  calendar         Calendar?  @relation(fields: [calendarId], references: [id])
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  profilePicture   String?

  GroupMember      GroupMember[]
  EventParticipant EventParticipant[]
  Notification     Notification[]
  AuditLog         AuditLog[]

  @@map("users")
}

model Group {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  iconUrl     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     GroupMember[]
  calendar    Calendar     @relation(fields: [calendarId], references: [id])
  calendarId  Int

  @@map("groups")
}

model GroupMember {
  groupId   Int
  userId    Int
  role      String       // Admin, Member
  status    String       // Active, Pending, Left
  group     Group        @relation(fields: [groupId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@id([groupId, userId])
  @@map("group_members")
}

model Calendar {
  id          Int       @id @default(autoincrement())
  ownerId     Int
  ownerType   String    // User or Group
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  events      Event[]
  
  // Composite unique constraint for ownerId and ownerType
  @@unique([ownerId, ownerType])

  // Optional: Composite index for faster filtering by ownerId and ownerType
  @@index([ownerId, ownerType])
  @@map("calendars")
  User User[]
  Group Group[]
}

model Event {
  id             Int               @id @default(autoincrement())
  title          String
  description    String?
  startTime      DateTime
  endTime        DateTime
  recurrence     String?           // Recurring event type (daily, weekly, monthly)
  endRecurrence  DateTime?         // End date for recurrence
  calendarId     Int
  calendar       Calendar          @relation(fields: [calendarId], references: [id])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  participants   EventParticipant[]

  @@map("events")
}

model EventParticipant {
  eventId Int
  userId  Int
  status  String       // Accepted, Declined, Pending
  event   Event         @relation(fields: [eventId], references: [id])
  user    User          @relation(fields: [userId], references: [id])

  @@id([eventId, userId])
  @@map("event_participants")
}

model Template {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  ownerId     Int
  elements    Json
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("templates")
}

model SavingPlan {
  id             Int           @id @default(autoincrement())
  goalAmount     Float
  currentBalance Float          @default(0)
  frequency      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  transactions   Transaction[]  // Relation to the Transaction model

  @@map("saving_plans")
}

model Transaction {
  id          Int       @id @default(autoincrement())
  savingPlanId Int
  type        String    // Either "Deposit" or "Withdraw"
  amount      Float
  date        DateTime  @default(now())
  savingPlan  SavingPlan @relation(fields: [savingPlanId], references: [id])

  @@map("transactions")
}


model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int
  type        String   // Event Invitation, Friend Request, Saving Plan Reminder
  status      String   // Read, Unread
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actionType  String   // Create, Update, Delete
  entityType  String   // User, Group, Event, etc.
  userId      Int
  details     Json?    // Additional metadata for actions
  timestamp   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}